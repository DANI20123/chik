workflows:
  unity-android-workflow:
    name: Unity Android Build
    triggering:
      events: []
    
    environment:
      unity: "2022.3.62f3"
      groups:
        - unity_credentials
      vars:
        PROJECT_NAME: "ChikenLine"  # –ë–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤!
        BUNDLE_ID: "com.line.egg"
        VERSION_NAME: "1.0.0"
        VERSION_CODE: "1"
        UNITY_VERSION: "2022.3.62f3"  # –î–û–ë–ê–í–¨ –≠–¢–£ –°–¢–†–û–ß–ö–£!
    
    scripts:
      # 1. –ê–ö–¢–ò–í–ê–¶–ò–Ø –õ–ò–¶–ï–ù–ó–ò–ò (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø)
      - name: Activate Unity License
        script: |
          echo "üì± –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ª–∏—Ü–µ–Ω–∑–∏–∏ Unity..."
          echo "Serial: ${UNITY_SERIAL:0:10}..."
          
          # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—É—â—É—é –ª–∏—Ü–µ–Ω–∑–∏—é
          echo "–í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—É—â—É—é –ª–∏—Ü–µ–Ω–∑–∏—é..."
          /Users/Shared/Unity/Hub/Editor/$UNITY_VERSION/Unity.app/Contents/MacOS/Unity \
            -batchmode -nographics -quit -returnlicense \
            -logFile /tmp/return.log 2>&1 || true
          
          sleep 3
          
          # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω–æ–≤—É—é –ª–∏—Ü–µ–Ω–∑–∏—é
          echo "–ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ª–∏—Ü–µ–Ω–∑–∏—é..."
          /Users/Shared/Unity/Hub/Editor/$UNITY_VERSION/Unity.app/Contents/MacOS/Unity \
            -batchmode \
            -nographics \
            -quit \
            -serial "$UNITY_SERIAL" \
            -username "$UNITY_USERNAME" \
            -password "$UNITY_PASSWORD" \
            -logFile /tmp/activate.log \
            2>&1
          
          ACTIVATION_RESULT=$?
          echo "–ö–æ–¥ –≤—ã—Ö–æ–¥–∞: $ACTIVATION_RESULT"
          
          if [ $ACTIVATION_RESULT -eq 0 ]; then
            echo "‚úÖ –õ–∏—Ü–µ–Ω–∑–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!"
            echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∞:"
            tail -10 /tmp/activate.log
          else
            echo "‚ùå –û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏! –õ–æ–≥:"
            cat /tmp/activate.log
            exit 1
          fi
      
      # 2. –°–±–æ—Ä–∫–∞ AAB
      - name: Build Android App Bundle
        script: |
          echo "üì¶ –°–±–æ—Ä–∫–∞ AAB..."
          
          /Users/Shared/Unity/Hub/Editor/$UNITY_VERSION/Unity.app/Contents/MacOS/Unity \
            -batchmode \
            -nographics \
            -quit \
            -executeMethod BuildCommand.PerformBuild \
            -outputPath "$CM_BUILD_DIR/$PROJECT_NAME.aab" \
            -buildTarget "Android" \
            -androidAppBundle "true" \
            -logFile "$CM_BUILD_DIR/build.log"
          
          if [ -f "$CM_BUILD_DIR/$PROJECT_NAME.aab" ]; then
            echo "‚úÖ AAB –≥–æ—Ç–æ–≤!"
            ls -la "$CM_BUILD_DIR/$PROJECT_NAME.aab"
          else
            echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ AAB"
            cat "$CM_BUILD_DIR/build.log"
            exit 1
          fi
      
      # 3. –°–±–æ—Ä–∫–∞ APK
      - name: Build APK
        script: |
          echo "üì± –°–±–æ—Ä–∫–∞ APK..."
          
          /Users/Shared/Unity/Hub/Editor/$UNITY_VERSION/Unity.app/Contents/MacOS/Unity \
            -batchmode \
            -nographics \
            -quit \
            -executeMethod BuildCommand.PerformBuild \
            -outputPath "$CM_BUILD_DIR/$PROJECT_NAME.apk" \
            -buildTarget "Android" \
            -androidAppBundle "false" \
            -logFile "$CM_BUILD_DIR/build_apk.log"
          
          if [ -f "$CM_BUILD_DIR/$PROJECT_NAME.apk" ]; then
            echo "‚úÖ APK –≥–æ—Ç–æ–≤!"
            ls -la "$CM_BUILD_DIR/$PROJECT_NAME.apk"
          else
            echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ APK"
            cat "$CM_BUILD_DIR/build_apk.log"
            exit 1
          fi
    
    artifacts:
      - "$CM_BUILD_DIR/*.aab"
      - "$CM_BUILD_DIR/*.apk"
      - "$CM_BUILD_DIR/*.log"
    
   
