# Codemagic YAML –¥–ª—è Unity Android —Å–±–æ—Ä–∫–∏
# –û–±–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–¥ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é CodeMagic
# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: https://docs.codemagic.io/yaml/yaml-getting-started/

workflows:
  unity-android-workflow:
    name: Unity Android Build
    
    # –¢—Ä–∏–≥–≥–µ—Ä—ã —Å–±–æ—Ä–∫–∏ - —Ç–æ–ª—å–∫–æ —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
    triggering:
      events: []  # –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ = —Ç–æ–ª—å–∫–æ —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
    
    # –°—Ä–µ–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    environment:
      # –£–∫–∞–∂–∏—Ç–µ —Å–≤–æ—é –≤–µ—Ä—Å–∏—é Unity
      unity: "2022.3.62f2"  # –ü–†–û–°–¢–û –°–¢–†–û–ö–ê, –Ω–µ –æ–±—ä–µ–∫—Ç!
      
      # –ì—Ä—É–ø–ø—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö (–Ω–∞—Å—Ç—Ä–æ–∏–º –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ CodeMagic)
      groups:
        - unity_credentials
        - android_signing
      
      # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞
      vars:
        PROJECT_NAME: "Chiken Line"
        BUNDLE_ID: "com.line.egg"
        VERSION_NAME: "1.0.0"
        VERSION_CODE: "1"
    
    # –°–∫—Ä–∏–ø—Ç—ã —Å–±–æ—Ä–∫–∏
    scripts:
          # 1. –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ª–∏—Ü–µ–Ω–∑–∏–∏ Unity (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –í–ê–†–ò–ê–ù–¢)
    - name: Activate Unity License
      script: |
        echo "üì± –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ª–∏—Ü–µ–Ω–∑–∏–∏ Unity..."
        echo "Serial: ${UNITY_SERIAL:0:10}..."  # –õ–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        
        # –í–ê–ñ–ù–û: –°–Ω–∞—á–∞–ª–∞ –í–°–ï–ì–î–ê –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ª–∏—Ü–µ–Ω–∑–∏—é (–µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å)
        echo "–í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—É—â—É—é –ª–∏—Ü–µ–Ω–∑–∏—é..."
        unity-editor -batchmode -nographics -quit -returnlicense -logFile /tmp/return.log 2>&1 || true
        
        # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ
        sleep 5
        
        # –¢–µ–ø–µ—Ä—å –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω–æ–≤—É—é –ª–∏—Ü–µ–Ω–∑–∏—é
        echo "–ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ª–∏—Ü–µ–Ω–∑–∏—é..."
        /Users/Shared/Unity/Hub/Editor/$UNITY_VERSION/Unity.app/Contents/MacOS/Unity \
          -batchmode \
          -nographics \
          -quit \
          -serial "$UNITY_SERIAL" \
          -username "$UNITY_USERNAME" \
          -password "$UNITY_PASSWORD" \
          -logFile /tmp/activate.log \
          2>&1
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        ACTIVATION_RESULT=$?
        echo "–ö–æ–¥ –≤—ã—Ö–æ–¥–∞ Unity: $ACTIVATION_RESULT"
        
        if [ $ACTIVATION_RESULT -eq 0 ]; then
          echo "‚úÖ –õ–∏—Ü–µ–Ω–∑–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
          echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∞:"
          tail -20 /tmp/activate.log
        else
          echo "‚ùå –û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏! –ü–æ–ª–Ω—ã–π –ª–æ–≥:"
          cat /tmp/activate.log
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏
          if grep -q "Invalid username or password" /tmp/activate.log; then
            echo "–û–®–ò–ë–ö–ê: –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å Unity"
          elif grep -q "Failed to activate" /tmp/activate.log; then
            echo "–û–®–ò–ë–ö–ê: –ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ä–∏–π–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º"
          elif grep -q "license is already in use" /tmp/activate.log; then
            echo "–û–®–ò–ë–ö–ê: –õ–∏—Ü–µ–Ω–∑–∏—è —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞ –¥—Ä—É–≥–æ–º –∫–æ–º–ø–µ"
          fi
          
          exit 1
        fi
      
      # 2. –°–±–æ—Ä–∫–∞ AAB (App Bundle)
      - name: Build Android App Bundle (AAB)
        script: |
          echo "üì¶ –°–±–æ—Ä–∫–∞ AAB —Ñ–∞–π–ª–∞..."
          
          # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è —Å–±–æ—Ä–∫–∏
          mkdir -p "$CM_BUILD_DIR"
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É —á–µ—Ä–µ–∑ Unity
          unity-editor \
            -batchmode \
            -nographics \
            -quit \
            -executeMethod BuildCommand.PerformBuild \
            -outputPath "$CM_BUILD_DIR/$PROJECT_NAME.aab" \
            -buildTarget "Android" \
            -androidAppBundle "true" \
            -development "false" \
            -logFile "$CM_BUILD_DIR/build_aab.log"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          if [ -f "$CM_BUILD_DIR/$PROJECT_NAME.aab" ]; then
            echo "‚úÖ AAB —Å–æ–±—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ!"
            echo "–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $(du -h "$CM_BUILD_DIR/$PROJECT_NAME.aab" | cut -f1)"
          else
            echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ AAB"
            cat "$CM_BUILD_DIR/build_aab.log"
            exit 1
          fi
      
      # 3. –°–±–æ—Ä–∫–∞ APK (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
      - name: Build APK (ARM64)
        script: |
          echo "üì± –°–±–æ—Ä–∫–∞ APK —Ñ–∞–π–ª–∞..."
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É APK
          unity-editor \
            -batchmode \
            -nographics \
            -quit \
            -executeMethod BuildCommand.PerformBuild \
            -outputPath "$CM_BUILD_DIR/$PROJECT_NAME.apk" \
            -buildTarget "Android" \
            -androidAppBundle "false" \
            -development "false" \
            -logFile "$CM_BUILD_DIR/build_apk.log"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          if [ -f "$CM_BUILD_DIR/$PROJECT_NAME.apk" ]; then
            echo "‚úÖ APK —Å–æ–±—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ!"
            echo "–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $(du -h "$CM_BUILD_DIR/$PROJECT_NAME.apk" | cut -f1)"
          else
            echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ APK"
            cat "$CM_BUILD_DIR/build_apk.log"
            exit 1
          fi
    
    # –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã (—Å–æ—Ö—Ä–∞–Ω—è–µ–º—ã–µ —Ñ–∞–π–ª—ã)
    artifacts:
      - "build/**/*.aab"
      - "build/**/*.apk"
      - "build/**/*.log"
      - "$CM_BUILD_DIR/*.aab"
      - "$CM_BUILD_DIR/*.apk"
      - "$CM_BUILD_DIR/*.log"
    
   
