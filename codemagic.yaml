# Codemagic YAML –¥–ª—è Unity Android —Å–±–æ—Ä–∫–∏
# –û–±–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–¥ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é CodeMagic
# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: https://docs.codemagic.io/yaml/yaml-getting-started/

workflows:
  unity-android-workflow:
    name: Unity Android Build
    
    # –¢—Ä–∏–≥–≥–µ—Ä—ã —Å–±–æ—Ä–∫–∏ - —Ç–æ–ª—å–∫–æ —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
    triggering:
      events: []  # –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ = —Ç–æ–ª—å–∫–æ —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
    
    # –°—Ä–µ–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    environment:
      # –£–∫–∞–∂–∏—Ç–µ —Å–≤–æ—é –≤–µ—Ä—Å–∏—é Unity
      unity: "2022.3.62f3"  # –ü–†–û–°–¢–û –°–¢–†–û–ö–ê, –Ω–µ –æ–±—ä–µ–∫—Ç!
      
      # –ì—Ä—É–ø–ø—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö (–Ω–∞—Å—Ç—Ä–æ–∏–º –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ CodeMagic)
      groups:
        - unity_credentials
        - android_signing
      
      # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞
      vars:
        PROJECT_NAME: "Chiken Line"
        BUNDLE_ID: "com.line.egg"
        VERSION_NAME: "1.0.0"
        VERSION_CODE: "1"
    
    # –°–∫—Ä–∏–ø—Ç—ã —Å–±–æ—Ä–∫–∏
    scripts:
      # 1. –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ª–∏—Ü–µ–Ω–∑–∏–∏ Unity
      - name: Activate Unity License
        script: |
          echo "üì± –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ª–∏—Ü–µ–Ω–∑–∏–∏ Unity..."
          
          # –°–Ω–∞—á–∞–ª–∞ –ø–æ–ø—Ä–æ–±—É–µ–º –≤–µ—Ä–Ω—É—Ç—å –ª–∏—Ü–µ–Ω–∑–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
          unity-editor -batchmode -nographics -quit -returnlicense -logFile /tmp/unity_return.log 2>/dev/null || true
          
          # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ª–∏—Ü–µ–Ω–∑–∏—é
          unity-editor \
            -batchmode \
            -nographics \
            -quit \
            -logFile /tmp/unity_activate.log \
            -serial "$UNITY_SERIAL" \
            -username "$UNITY_USERNAME" \
            -password "$UNITY_PASSWORD" \
            > /tmp/unity_output.log 2>&1
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
          if [ $? -eq 0 ]; then
            echo "‚úÖ –õ–∏—Ü–µ–Ω–∑–∏—è Unity –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
          else
            echo "‚ùå –û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ª–∏—Ü–µ–Ω–∑–∏–∏ Unity"
            cat /tmp/unity_activate.log
            exit 1
          fi
      
      # 2. –°–±–æ—Ä–∫–∞ AAB (App Bundle)
      - name: Build Android App Bundle (AAB)
        script: |
          echo "üì¶ –°–±–æ—Ä–∫–∞ AAB —Ñ–∞–π–ª–∞..."
          
          # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è —Å–±–æ—Ä–∫–∏
          mkdir -p "$CM_BUILD_DIR"
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É —á–µ—Ä–µ–∑ Unity
          unity-editor \
            -batchmode \
            -nographics \
            -quit \
            -executeMethod BuildCommand.PerformBuild \
            -outputPath "$CM_BUILD_DIR/$PROJECT_NAME.aab" \
            -buildTarget "Android" \
            -androidAppBundle "true" \
            -development "false" \
            -logFile "$CM_BUILD_DIR/build_aab.log"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          if [ -f "$CM_BUILD_DIR/$PROJECT_NAME.aab" ]; then
            echo "‚úÖ AAB —Å–æ–±—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ!"
            echo "–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $(du -h "$CM_BUILD_DIR/$PROJECT_NAME.aab" | cut -f1)"
          else
            echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ AAB"
            cat "$CM_BUILD_DIR/build_aab.log"
            exit 1
          fi
      
      # 3. –°–±–æ—Ä–∫–∞ APK (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
      - name: Build APK (ARM64)
        script: |
          echo "üì± –°–±–æ—Ä–∫–∞ APK —Ñ–∞–π–ª–∞..."
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É APK
          unity-editor \
            -batchmode \
            -nographics \
            -quit \
            -executeMethod BuildCommand.PerformBuild \
            -outputPath "$CM_BUILD_DIR/$PROJECT_NAME.apk" \
            -buildTarget "Android" \
            -androidAppBundle "false" \
            -development "false" \
            -logFile "$CM_BUILD_DIR/build_apk.log"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          if [ -f "$CM_BUILD_DIR/$PROJECT_NAME.apk" ]; then
            echo "‚úÖ APK —Å–æ–±—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ!"
            echo "–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $(du -h "$CM_BUILD_DIR/$PROJECT_NAME.apk" | cut -f1)"
          else
            echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ APK"
            cat "$CM_BUILD_DIR/build_apk.log"
            exit 1
          fi
    
    # –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã (—Å–æ—Ö—Ä–∞–Ω—è–µ–º—ã–µ —Ñ–∞–π–ª—ã)
    artifacts:
      - "build/**/*.aab"
      - "build/**/*.apk"
      - "build/**/*.log"
      - "$CM_BUILD_DIR/*.aab"
      - "$CM_BUILD_DIR/*.apk"
      - "$CM_BUILD_DIR/*.log"
    
   
