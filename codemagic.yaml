# Codemagic YAML –¥–ª—è Unity Android —Å–±–æ—Ä–∫–∏
# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: https://docs.codemagic.io/yaml/yaml-getting-started/

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
workflows:
  unity-android-workflow:
    name: Unity Android Build
    # –û—Ç–∫–ª—é—á–∞–µ–º —Å–±–æ—Ä–∫—É –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø—É—à–µ (–≤–∫–ª—é—á–∞–µ–º –≤—Ä—É—á–Ω—É—é)
    triggering:
      events:
        - manual
    
    # –°—Ä–µ–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    environment:
      # –ì—Ä—É–ø–ø—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö (–Ω–∞—Å—Ç—Ä–æ–∏–º –ø–æ–∑–∂–µ –≤ CodeMagic)
      groups:
        - unity_credentials  # –î–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ Unity
        - android_signing    # –î–ª—è –ø–æ–¥–ø–∏—Å–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      
      # –í–µ—Ä—Å–∏—è Unity (–ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–Æ!)
      unity:
        version: 2022.3.62f3
      
      # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
      vars:
        # –ò–º—è –ø—Ä–æ–µ–∫—Ç–∞ (–º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å)
        PROJECT_NAME: "Chiken Line"
        # –ò–º—è –ø–∞–∫–µ—Ç–∞ (–î–û–õ–ñ–ù–û —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å Package Name –≤ Unity!)
        BUNDLE_ID: "com.line.egg"
        # –í–µ—Ä—Å–∏—è (–±—É–¥–µ—Ç —É–≤–µ–ª–∏—á–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
        VERSION_NAME: "1.0.0"
    
    # –°–∫—Ä–∏–ø—Ç—ã —Å–±–æ—Ä–∫–∏
    scripts:
      # 1. –ê–∫—Ç–∏–≤–∞—Ü–∏—è Unity –ª–∏—Ü–µ–Ω–∑–∏–∏
      - name: Activate Unity License
        script: |
          echo "üì± Activating Unity license..."
          unity-editor \
            -batchmode \
            -nographics \
            -quit \
            -logFile /tmp/unity_activate.log \
            -serial "$UNITY_SERIAL" \
            -username "$UNITY_USERNAME" \
            -password "$UNITY_PASSWORD"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
          if grep -q "Failed to activate" /tmp/unity_activate.log; then
            echo "‚ùå Unity license activation failed"
            cat /tmp/unity_activate.log
            exit 1
          else
            echo "‚úÖ Unity license activated successfully"
          fi
      
      # 2. –°–±–æ—Ä–∫–∞ AAB (–¥–ª—è Google Play)
      - name: Build Android App Bundle (AAB)
        script: |
          echo "üì¶ Building AAB file..."
          unity-editor \
            -batchmode \
            -nographics \
            -quit \
            -executeMethod BuildCommand.PerformBuild \
            -outputPath "$CM_BUILD_DIR/$PROJECT_NAME.aab" \
            -buildTarget "Android" \
            -androidAppBundle "true" \
            -development "false" \
            -logFile /tmp/unity_build_aab.log
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏
          if [ -f "$CM_BUILD_DIR/$PROJECT_NAME.aab" ]; then
            echo "‚úÖ AAB build successful!"
            ls -la "$CM_BUILD_DIR/$PROJECT_NAME.aab"
          else
            echo "‚ùå AAB build failed"
            cat /tmp/unity_build_aab.log
            exit 1
          fi
      
      # 3. –°–±–æ—Ä–∫–∞ APK (arm64)
      - name: Build APK (ARM64)
        script: |
          echo "üì± Building APK file..."
          unity-editor \
            -batchmode \
            -nographics \
            -quit \
            -executeMethod BuildCommand.PerformBuild \
            -outputPath "$CM_BUILD_DIR/$PROJECT_NAME.apk" \
            -buildTarget "Android" \
            -androidAppBundle "false" \
            -development "false" \
            -logFile /tmp/unity_build_apk.log
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏
          if [ -f "$CM_BUILD_DIR/$PROJECT_NAME.apk" ]; then
            echo "‚úÖ APK build successful!"
            ls -la "$CM_BUILD_DIR/$PROJECT_NAME.apk"
          else
            echo "‚ùå APK build failed"
            cat /tmp/unity_build_apk.log
            exit 1
          fi
    
    # –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã (—á—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏)
    artifacts:
      - "$CM_BUILD_DIR/*.aab"
      - "$CM_BUILD_DIR/*.apk"
      - "/tmp/unity_*.log"  # –õ–æ–≥–∏ –¥–ª—è –¥–µ–±–∞–≥–∞
 
      
      # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –≤ Google Play (–ø–æ–∑–∂–µ)
      # google_play:
      #   credentials: $GCLOUD_SERVICE_ACCOUNT_CREDENTIALS
      #   track: internal
      #   in_app_update_priority: 0